<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫°m Hu·∫•n Luy·ªán Morse & Semaphore - HLV C·∫•p 2 Trung ∆Ø∆°ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .code-font {
            font-family: 'JetBrains+Mono', monospace;
        }

        .active-glow {
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.7);
            transition: all 0.1s ease;
        }

        /* Tay v√† c·ªù g·∫Øn li·ªÅn, xoay quanh vai (50, 40) */
        #armLeft, #armRight {
            transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: 50px 40px;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .correct-pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .status-blink { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-2 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="bg-emerald-800 text-white p-6 rounded-3xl shadow-2xl mb-6 flex flex-col md:flex-row items-center gap-6">
            <div class="bg-white text-emerald-800 p-4 rounded-full w-20 h-20 flex items-center justify-center font-bold text-3xl shadow-inner border-4 border-emerald-600">
                HLV
            </div>
            <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight uppercase text-white">Tr·∫°m Hu·∫•n Luy·ªán Morse & Semaphore</h1>
                <p class="text-emerald-100 opacity-90 italic text-sm md:text-base tracking-wide">K·ªπ nƒÉng chuy√™n gia - Hu·∫•n luy·ªán vi√™n C·∫•p 2 Trung ∆∞∆°ng</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Main Controls -->
                <section class="bg-white p-6 rounded-3xl shadow-md border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <label id="inputLabel" class="text-slate-700 font-bold flex items-center gap-2">
                            <span class="text-emerald-600">üìù</span> So·∫°n th·∫£o b·∫£n tin:
                        </label>
                        <div class="flex gap-2">
                            <button id="btnAiQuiz" class="text-sm bg-orange-100 text-orange-700 hover:bg-orange-200 px-4 py-2 rounded-full font-bold transition-all flex items-center gap-2">
                                <span id="aiIcon">üéØ Th·ª≠ th√°ch Ki·ªÉm tra</span>
                            </button>
                            <button id="btnNormalMode" class="text-sm bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-full font-bold transition-all hidden">
                                üîô Quay l·∫°i T·ª± luy·ªán
                            </button>
                        </div>
                    </div>

                    <div id="normalInputGroup">
                        <textarea id="textInput" 
                            class="w-full h-24 p-4 bg-slate-50 border border-slate-300 rounded-2xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all text-xl font-medium"
                            placeholder="Nh·∫≠p n·ªôi dung (V√≠ d·ª•: 22/12)..."></textarea>
                    </div>

                    <div id="testInputGroup" class="hidden space-y-4">
                        <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 mb-4 text-orange-800 text-sm font-bold text-center">
                            ‚ö†Ô∏è B·∫¢N TIN ƒê√É B·ªä ·∫®N. H√£y gi·∫£i m√£ t√≠n hi·ªáu!
                        </div>
                        <input type="text" id="userGuess" 
                            class="w-full p-5 bg-white border-2 border-orange-300 rounded-2xl focus:ring-4 focus:ring-orange-500/20 focus:border-orange-500 outline-none transition-all text-xl font-bold text-orange-700 text-center"
                            placeholder="Nh·∫≠p ƒë√°p √°n gi·∫£i m√£ ƒë∆∞·ª£c...">
                        <div class="flex gap-2">
                            <button id="btnCheckAnswer" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-bold flex-1 shadow-lg active:scale-95">Ki·ªÉm tra</button>
                            <button id="btnToggleReveal" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-3 rounded-xl font-bold">ƒê√°p √°n</button>
                        </div>
                    </div>

                    <div class="mt-6 flex flex-wrap gap-3">
                        <button id="btnPlayMorse" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-lg active:scale-95 flex-1 min-w-[150px]">
                            <span class="text-xl">üîä</span> Morse
                        </button>
                        <button id="btnPlaySema" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-lg active:scale-95 flex-1 min-w-[150px]">
                            <span class="text-xl">üö©</span> Semaphore
                        </button>
                        <button id="btnStop" class="bg-slate-800 hover:bg-black text-white px-8 py-4 rounded-2xl font-bold shadow-lg active:scale-95">D·ª´ng</button>
                    </div>
                </section>

                <section id="resultSection" class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 overflow-hidden transition-all">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-emerald-800">üì° Ph√¢n t√≠ch chu·∫©n</h3>
                    <div id="answerContent">
                        <div id="telexPreview" class="bg-slate-900 text-emerald-400 p-5 rounded-2xl code-font min-h-[60px] text-xl break-all mb-3 leading-relaxed">Ch∆∞a c√≥ b·∫£n tin...</div>
                        <div id="morsePreview" class="bg-slate-100 text-slate-600 p-5 rounded-2xl code-font text-2xl tracking-widest break-all">...</div>
                    </div>
                </section>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Semaphore visualization -->
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 text-center relative">
                    <h3 class="font-bold text-slate-700 mb-6 text-emerald-800 tracking-wider uppercase">Tr·∫°m ph√°t Semaphore</h3>
                    <div id="semaContainer" class="flex justify-center bg-slate-50 p-6 rounded-3xl h-64 items-center border border-slate-100">
                        <svg id="semaSvg" viewBox="0 0 100 100" class="w-full h-full max-w-[200px]">
                            <circle cx="50" cy="25" r="8" fill="#334155" />
                            <line x1="50" y1="33" x2="50" y2="70" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            <line x1="50" y1="70" x2="35" y2="95" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            <line x1="50" y1="70" x2="65" y2="95" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            
                            <!-- Arm Left -->
                            <g id="armLeft">
                                <line x1="50" y1="40" x2="50" y2="5" stroke="#991b1b" stroke-width="5" stroke-linecap="round" />
                                <rect x="42" y="5" width="16" height="16" fill="#ef4444" rx="1" />
                                <polygon points="42,5 58,5 42,21" fill="#fbbf24" />
                            </g>
                            
                            <!-- Arm Right -->
                            <g id="armRight">
                                <line x1="50" y1="40" x2="50" y2="5" stroke="#991b1b" stroke-width="5" stroke-linecap="round" />
                                <rect x="42" y="5" width="16" height="16" fill="#ef4444" rx="1" />
                                <polygon points="42,5 58,5 42,21" fill="#fbbf24" />
                            </g>
                        </svg>
                    </div>
                    <div class="mt-4 flex flex-col items-center">
                        <div id="semaMode" class="text-[10px] font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full mb-1 h-6 uppercase tracking-widest border border-slate-200"></div>
                        <div id="semaStatus" class="text-xs font-bold text-slate-500 mb-1 h-4 uppercase tracking-widest"></div>
                        <div id="semaChar" class="text-5xl font-black text-blue-600 h-12 italic drop-shadow-sm"></div>
                    </div>
                </div>

                <!-- Morse Visualization -->
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 text-center">
                    <h3 class="font-bold text-slate-700 mb-4 uppercase">ƒê√®n t√≠n hi·ªáu Morse</h3>
                    <div id="morseLight" class="w-20 h-20 bg-slate-200 rounded-full mx-auto border-4 border-slate-300 transition-colors"></div>
                </div>

                <!-- Configuration -->
                <div class="bg-emerald-900 text-white p-6 rounded-3xl shadow-xl">
                    <h3 class="font-bold mb-6 flex items-center gap-2 text-white uppercase">‚öôÔ∏è C·∫•u h√¨nh HLV</h3>
                    <div class="space-y-5">
                        <!-- √î nh·∫≠p API Key: S·∫Ω b·ªã ·∫©n n·∫øu ch·∫°y trong Canvas -->
                        <div id="apiConfigContainer">
                            <div class="flex justify-between text-[10px] font-bold uppercase text-orange-300 mb-2 tracking-widest">
                                <span>Kh√≥a API Gemini (D√πng cho web ri√™ng)</span>
                            </div>
                            <input type="password" id="customApiKey" placeholder="D√°n kh√≥a API Gemini v√†o ƒë√¢y..." class="w-full p-2 bg-emerald-800 text-white text-xs rounded-lg border border-emerald-700 outline-none focus:border-orange-400 transition-all">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold uppercase text-emerald-300 mb-2 tracking-widest">
                                <span>T·ªëc ƒë·ªô Morse</span>
                                <span><span id="wpmVal">15</span> WPM</span>
                            </div>
                            <input type="range" id="wpmSlider" min="5" max="35" value="15" class="w-full accent-emerald-400 h-1.5 bg-emerald-800 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold uppercase text-blue-300 mb-2 tracking-widest">
                                <span>T·ªëc ƒë·ªô Semaphore</span>
                                <span><span id="semaVal">1000</span> ms</span>
                            </div>
                            <input type="range" id="semaSlider" min="300" max="3000" step="100" value="1000" class="w-full accent-blue-400 h-1.5 bg-emerald-800 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl hidden opacity-0 transition-all font-bold shadow-2xl z-50 border border-slate-700 text-center"></div>

    <script>
        // M·∫∑c ƒë·ªãnh tr·ªëng ƒë·ªÉ m√¥i tr∆∞·ªùng Gemini t·ª± x·ª≠ l√Ω. 
        // Khi ch·∫°y b√™n ngo√†i, ·ª©ng d·ª•ng s·∫Ω l·∫•y kh√≥a t·ª´ √¥ nh·∫≠p li·ªáu customApiKey.
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'morse-sema-trainer';
        const isGeminiEnv = typeof __app_id !== 'undefined';

        // ·∫®n c·∫•u h√¨nh API n·∫øu ƒëang ·ªü trong Gemini
        if (isGeminiEnv) {
            const apiContainer = document.getElementById('apiConfigContainer');
            if (apiContainer) apiContainer.style.display = 'none';
        }

        const MORSE_MAP = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....',
            'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---', 'P': '.--.',
            'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....',
            '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----', ' ': '/'
        };

        const TELEX_MAP = {
            '√°': 'as', '√†': 'af', '·∫£': 'ar', '√£': 'ax', '·∫°': 'aj', '√¢': 'aa', '·∫•': 'aas', '·∫ß': 'aaf', '·∫©': 'aar', '·∫´': 'aax', '·∫≠': 'aaj', 'ƒÉ': 'aw', '·∫Ø': 'aws', '·∫±': 'awf', '·∫≥': 'awr', '·∫µ': 'awx', '·∫∑': 'awj',
            '√©': 'es', '√®': 'ef', '·∫ª': 'er', '·∫Ω': 'ex', '·∫π': 'ej', '√™': 'ee', '·∫ø': 'ees', '·ªÅ': 'eef', '·ªÉ': 'eer', '·ªÖ': 'eex', '·ªá': 'eej',
            '√≠': 'is', '√¨': 'if', '·ªâ': 'ir', 'ƒ©': 'ix', '·ªã': 'ij', '√≥': 'os', '√≤': 'of', '·ªè': 'or', '√µ': 'ox', '·ªç': 'oj', '√¥': 'oo', '·ªë': 'oos', '·ªì': 'oof', '·ªï': 'oor', '·ªó': 'oox', '·ªô': 'ooj',
            '∆°': 'ow', '·ªõ': 'ows', '·ªù': 'owf', '·ªü': 'owr', '·ª°': 'owx', '·ª£': 'owj', '√∫': 'us', '√π': 'uf', '·ªß': 'ur', '≈©': 'ux', '·ª•': 'uj', '∆∞': 'uw', '·ª©': 'uws', '·ª´': 'uwf', '·ª≠': 'uwr', '·ªØ': 'uwx', '·ª±': 'uwj',
            '√Ω': 'ys', '·ª≥': 'yf', '·ª∑': 'yr', '·ªπ': 'yx', '·ªµ': 'yj', 'ƒë': 'dd'
        };

        const NUM_MAP = { '1': 'A', '2': 'B', '3': 'C', '4': 'D', '5': 'E', '6': 'F', '7': 'G', '8': 'H', '9': 'I', '0': 'J' };

        const SEMA_ANGLES = {
            'A': [180, 225], 'B': [180, 270], 'C': [180, 315], 'D': [180, 0],
            'E': [180, 45],  'F': [180, 90],  'G': [180, 135], 'H': [225, 270],
            'I': [225, 315], 'K': [225, 0],   'L': [225, 45],  'M': [225, 90],
            'N': [225, 135], 'O': [270, 315], 'P': [270, 0],   'Q': [270, 45],
            'R': [270, 90],  'S': [270, 135], 'T': [315, 0],   'U': [315, 45],
            'Y': [90, 315],  'V': [0, 135],   'W': [45, 90],   'X': [45, 135],
            'Z': [90, 135],  'J': [0, 90],    ' ': [180, 180],
            'SYSTEM': [0, 45], 
            'READY': [180, 180]
        };

        let audioCtx = null, oscillator = null, gainNode = null, isPlaying = false, isTestMode = false, currentTargetMessage = "", timeouts = [];

        function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination); } }

        function stopAll() {
            isPlaying = false; timeouts.forEach(clearTimeout); timeouts = [];
            if (gainNode) gainNode.gain.setTargetAtTime(0, audioCtx?.currentTime || 0, 0.05);
            document.getElementById('morseLight').className = 'w-20 h-20 bg-slate-200 rounded-full mx-auto border-4 border-slate-300';
            document.getElementById('semaChar').innerText = ""; document.getElementById('semaStatus').innerText = "";
            document.getElementById('semaMode').innerText = "";
            setArms(180, 180, 1);
        }

        function setArms(leftAngle, rightAngle, scale = 1) {
            document.getElementById('armLeft').style.transform = `rotate(${leftAngle}deg) scale(${scale})`;
            document.getElementById('armRight').style.transform = `rotate(${rightAngle}deg) scale(${scale})`;
        }

        async function playCircleEight(onComplete) {
            const speed = 120; const seq = [0, 45, 90, 135, 180, 225, 270, 315];
            document.getElementById('semaStatus').innerText = "V√íNG S·ªê 8";
            for (let r = 0; r < 2; r++) {
                for (let a of seq) {
                    if (!isPlaying) return;
                    setArms(a, a + 180, 1);
                    await new Promise(res => timeouts.push(setTimeout(res, speed)));
                }
            }
            onComplete();
        }

        function toTelex(text) {
            let processed = text.replace(/\//g, " THANG ");
            let res = ""; 
            for (let char of processed.toLowerCase()) { 
                res += TELEX_MAP[char] || char; 
            } 
            return res.toUpperCase();
        }

        function playSemaphore() {
            stopAll(); isPlaying = true;
            const text = isTestMode ? currentTargetMessage : document.getElementById('textInput').value;
            if (!text) return showToast("Vui l√≤ng so·∫°n b·∫£n tin!");
            
            const telex = toTelex(text);
            const rawChars = telex.split('');
            const speed = parseInt(document.getElementById('semaSlider').value);
            
            playCircleEight(async () => {
                let currentMode = 'ALPHA'; 
                let lastSemaKey = "";

                for (let i = 0; i < rawChars.length; i++) {
                    if (!isPlaying) return;
                    let char = rawChars[i];
                    let isDigit = /\d/.test(char);

                    if (isDigit && currentMode === 'ALPHA') {
                        await showFrame('SYSTEM', "D·∫§U HI·ªÜU S·ªê", "CHUY·ªÇN S·ªê", speed);
                        currentMode = 'NUM';
                    } 
                    else if (!isDigit && char !== ' ' && currentMode === 'NUM') {
                        await showFrame('SYSTEM', "D·∫§U HI·ªÜU CH·ªÆ", "CHUY·ªÇN CH·ªÆ", speed);
                        currentMode = 'ALPHA';
                    }

                    let semaKey = char;
                    if (currentMode === 'NUM' && isDigit) {
                        semaKey = NUM_MAP[char]; 
                    }

                    if (semaKey === lastSemaKey && semaKey !== ' ') {
                        document.getElementById('semaStatus').innerText = "NH·∫§P CH·ªÆ";
                        document.getElementById('semaStatus').classList.add('status-blink', 'text-orange-600');
                        const angles = SEMA_ANGLES[semaKey] || SEMA_ANGLES['READY'];
                        setArms(angles[0], angles[1], 0.6); 
                        await new Promise(res => timeouts.push(setTimeout(res, speed / 3)));
                        document.getElementById('semaStatus').classList.remove('status-blink', 'text-orange-600');
                        setArms(angles[0], angles[1], 1);
                        await new Promise(res => timeouts.push(setTimeout(res, 50))); 
                    }

                    await showFrame(semaKey, char, currentMode === 'NUM' ? "S·ªê" : "CH·ªÆ", speed);
                    lastSemaKey = semaKey;
                }
                playCircleEight(() => { stopAll(); document.getElementById('semaChar').innerText = "H·∫æT"; });
            });
        }

        async function showFrame(key, label, modeLabel, duration) {
            if (!isPlaying) return;
            const angles = SEMA_ANGLES[key] || SEMA_ANGLES['READY'];
            document.getElementById('semaStatus').innerText = "TRUY·ªÄN TIN";
            document.getElementById('semaMode').innerText = modeLabel;
            const isSystem = key === 'SYSTEM' || key === 'READY';
            document.getElementById('semaChar').innerText = (isTestMode && !isSystem) ? "???" : label;
            setArms(angles[0], angles[1], 1);
            await new Promise(res => timeouts.push(setTimeout(res, duration)));
        }

        function playMorse() {
            initAudio(); stopAll(); isPlaying = true;
            const text = isTestMode ? currentTargetMessage : document.getElementById('textInput').value;
            const telex = toTelex(text);
            const wpm = parseInt(document.getElementById('wpmSlider').value);
            const dotTime = 1200 / wpm;
            let currentTime = 0;
            telex.split('').forEach(char => {
                if (!isPlaying) return;
                if (char === ' ') { currentTime += dotTime * 7; } 
                else {
                    (MORSE_MAP[char.toUpperCase()] || '').split('').forEach(sym => {
                        const dur = (sym === '.') ? dotTime : dotTime * 3;
                        const start = currentTime;
                        timeouts.push(setTimeout(() => {
                            if (!isPlaying) return;
                            document.getElementById('morseLight').classList.add('bg-emerald-400', 'active-glow');
                            if (oscillator) oscillator.stop();
                            oscillator = audioCtx.createOscillator();
                            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                            oscillator.connect(gainNode);
                            gainNode.gain.setTargetAtTime(1, audioCtx.currentTime, 0.005);
                            oscillator.start();
                        }, start));
                        timeouts.push(setTimeout(() => {
                            document.getElementById('morseLight').classList.remove('bg-emerald-400', 'active-glow');
                            gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.005);
                        }, currentTime + dur));
                        currentTime += dur + dotTime;
                    });
                    currentTime += dotTime * 3;
                }
            });
        }

        function updatePreviews(text) {
            const telex = toTelex(text);
            document.getElementById('telexPreview').innerText = telex || "Ch∆∞a c√≥ b·∫£n tin...";
            document.getElementById('morsePreview').innerText = toMorse(telex) || "...";
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (err) {
                if (retries <= 0) throw err;
                await new Promise(resolve => setTimeout(resolve, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }

        async function startAiQuiz() {
            const btn = document.getElementById('btnAiQuiz');
            btn.disabled = true; document.getElementById('aiIcon').innerHTML = '<span class="loader"></span>';
            
            // ∆Øu ti√™n s·ª≠ d·ª•ng kh√≥a trong code (m√¥i tr∆∞·ªùng Gemini) ho·∫∑c l·∫•y t·ª´ √¥ nh·∫≠p li·ªáu
            const activeKey = apiKey || document.getElementById('customApiKey').value;
            
            if (!isGeminiEnv && !activeKey) {
                showToast("Vui l√≤ng nh·∫≠p kh√≥a API Gemini trong m·ª•c C·∫•u h√¨nh HLV!");
                btn.disabled = false;
                document.getElementById('aiIcon').innerText = "üéØ Th·ª≠ th√°ch Ki·ªÉm tra";
                return;
            }

            const systemPrompt = "B·∫°n l√† HLV Morse/Semaphore. T·∫°o m·ªôt b·∫£n tin ti·∫øng Vi·ªát c√≥ d·∫•u v·ªõi ƒë·ªô d√†i t·ª´ 15 ƒë·∫øn 30 k√Ω t·ª±. N·ªôi dung c√≥ th·ªÉ l√† c√°c c√¢u kh·∫©u hi·ªáu, l·ªùi nh·∫Øc nh·ªü ho·∫∑c th√¥ng tin v·ªÅ phong tr√†o thi·∫øu nhi. B·∫£n tin KH√îNG nh·∫•t thi·∫øt ph·∫£i c√≥ s·ªë. Tr·∫£ v·ªÅ duy nh·∫•t b·∫£n tin ƒë√≥, kh√¥ng c√≥ th√™m vƒÉn b·∫£n n√†o kh√°c.";
            
            try {
                const result = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "T·∫°o m·ªôt b·∫£n tin th·ª≠ th√°ch ng·∫´u nhi√™n." }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    }
                );

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "S·∫¥N S√ÄNG V√å T·ªî QU·ªêC";
                currentTargetMessage = text;
                isTestMode = true;
                updatePreviews(text);
                document.getElementById('normalInputGroup').classList.add('hidden');
                document.getElementById('testInputGroup').classList.remove('hidden');
                document.getElementById('btnNormalMode').classList.remove('hidden');
                document.getElementById('resultSection').classList.add('invisible');
                document.getElementById('userGuess').value = "";
                showToast("ƒê√£ k√≠ch ho·∫°t ch·∫ø ƒë·ªô Ki·ªÉm tra!");
            } catch (e) {
                showToast("L·ªói API: Ki·ªÉm tra kh√≥a API ho·∫∑c k·∫øt n·ªëi m·∫°ng c·ªßa b·∫°n.");
            } finally {
                btn.disabled = false; document.getElementById('aiIcon').innerText = "üéØ Th·ª≠ th√°ch Ki·ªÉm tra";
            }
        }

        function toMorse(telex) { return telex.split('').map(c => MORSE_MAP[c.toUpperCase()] || '').join(' ').replace(/\s+/g, ' ').trim(); }

        document.getElementById('textInput').oninput = (e) => {
            updatePreviews(e.target.value);
        };

        document.getElementById('btnAiQuiz').onclick = startAiQuiz;
        document.getElementById('btnNormalMode').onclick = () => { isTestMode = false; stopAll(); exitTestMode(); };
        
        document.getElementById('btnCheckAnswer').onclick = () => {
            const guess = document.getElementById('userGuess').value.trim().toLowerCase().replace(/[.,!?;:]/g, "");
            const target = currentTargetMessage.trim().toLowerCase().replace(/[.,!?;:]/g, "");
            if (guess === target) { 
                showToast("QU√Å GI·ªéI! üéâ"); 
                document.getElementById('resultSection').classList.remove('invisible'); 
            }
            else showToast("Ch∆∞a ƒë√∫ng ƒë√¢u, t·∫≠p trung nh√©!");
        };

        document.getElementById('btnToggleReveal').onclick = () => document.getElementById('resultSection').classList.remove('invisible');
        document.getElementById('btnPlayMorse').onclick = playMorse;
        document.getElementById('btnPlaySema').onclick = playSemaphore;
        document.getElementById('btnStop').onclick = stopAll;
        document.getElementById('wpmSlider').oninput = (e) => document.getElementById('wpmVal').innerText = e.target.value;
        document.getElementById('semaSlider').oninput = (e) => document.getElementById('semaVal').innerText = e.target.value;

        function exitTestMode() {
            document.getElementById('normalInputGroup').classList.remove('hidden');
            document.getElementById('testInputGroup').classList.add('hidden');
            document.getElementById('btnNormalMode').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('invisible');
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.replace('opacity-0', 'opacity-100'), 10);
            setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); setTimeout(() => t.classList.add('hidden'), 500); }, 3000);
        }

        setArms(180, 180, 1);
    </script>
</body>
</html>