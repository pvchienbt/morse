<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ L√Ω HLV Kim ƒê·ªìng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Babel Standalone for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'Roboto Mono', monospace; }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900">
    <!-- Error Display Container -->
    <div id="error-container" style="display:none; padding: 20px; background: #fee2e2; color: #991b1b; border-bottom: 2px solid #7f1d1d;">
        <h3 style="font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è G·∫∑p l·ªói kh·ªüi ƒë·ªông</h3>
        <p id="error-message">Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet. ·ª®ng d·ª•ng c·∫ßn t·∫£i th∆∞ vi·ªán t·ª´ CDN.</p>
        <pre id="error-stack" style="font-size: 0.8em; overflow-x: auto; margin-top: 10px;"></pre>
    </div>

    <div id="root"></div>

    <script>
        // Global Error Handler to help user debug "web doesn't run" issues
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-stack').textContent = error ? error.stack : `${url}:${line}:${col}`;
        };

        // Polyfill for process.env needed by some libraries
        if (!window.process) {
            window.process = { env: {} };
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.3.1';
        import ReactDOM from 'https://esm.sh/react-dom@18.3.1/client';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@0.0.12';
        import { Play, Square, RefreshCw, Wand2, Radio, Flag, GraduationCap, BookOpen, Settings, Save, X, Key } from 'https://esm.sh/lucide-react@0.363.0';

        // --- TYPES & CONSTANTS ---
        const MORSE_CODE = {
            'A': '.-',    'B': '-...',  'C': '-.-.',  'D': '-..',
            'E': '.',     'F': '..-.',  'G': '--.',   'H': '....',
            'I': '..',    'J': '.---',  'K': '-.-',   'L': '.-..',
            'M': '--',    'N': '-.',    'O': '---',   'P': '.--.',
            'Q': '--.-',  'R': '.-.',   'S': '...',   'T': '-',
            'U': '..-',   'V': '...-',  'W': '.--',   'X': '-..-',
            'Y': '-.--',  'Z': '--..',
            '0': '-----', '1': '.----', '2': '..---', '3': '...--',
            '4': '....-', '5': '.....', '6': '-....', '7': '--...',
            '8': '---..', '9': '----.',
            '.': '.-.-.-', ',': '--..--', '?': '..--..',
            ' ': '/' 
        };

        const SEMAPHORE_CSS_ANGLES = {
            'REST': { rightArm: 0, leftArm: 0 },
            ' ': { rightArm: 0, leftArm: 0 },
            'A': { rightArm: 45, leftArm: 0 },
            'B': { rightArm: 90, leftArm: 0 },
            'C': { rightArm: 135, leftArm: 0 },
            'D': { rightArm: 180, leftArm: 0 },
            'E': { rightArm: 0, leftArm: 135 }, 
            'F': { rightArm: 0, leftArm: -90 },
            'G': { rightArm: 0, leftArm: -45 },
            'H': { rightArm: 90, leftArm: 45 },
            'I': { rightArm: 90, leftArm: 135 }, 
            'J': { rightArm: 180, leftArm: -90 },
            'K': { rightArm: 45, leftArm: 180 },
            'L': { rightArm: 45, leftArm: -135 },
            'M': { rightArm: 45, leftArm: -90 },
            'N': { rightArm: 45, leftArm: -45 },
            'O': { rightArm: 135, leftArm: -90 }, 
            'P': { rightArm: 180, leftArm: 45 },
            'Q': { rightArm: 180, leftArm: 90 },
            'R': { rightArm: 180, leftArm: 135 },
            'S': { rightArm: 180, leftArm: -45 },
            'T': { rightArm: 180, leftArm: -135 }, 
            'U': { rightArm: 135, leftArm: 180 },
            'V': { rightArm: -45, leftArm: 180 }, 
            'W': { rightArm: -90, leftArm: 135 }, 
            'X': { rightArm: -45, leftArm: 135 },
            'Y': { rightArm: 90, leftArm: 180 }, 
            'Z': { rightArm: -45, leftArm: -90 }, 
            'NUM': { rightArm: 180, leftArm: -135 }, 
        };

        // --- UTILS: VIETNAMESE ---
        const toTelex = (str) => {
            let text = str.replace(/ƒë/g, 'dd').replace(/ƒê/g, 'DD');
            text = text.normalize('NFD');
            const tones = {
                '\u0301': 'S', '\u0300': 'F', '\u0309': 'R', '\u0303': 'X', '\u0323': 'J',
            };
            const words = text.split(' ');
            return words.map(word => {
                let toneChar = '';
                let newWord = '';
                for (const char of word) {
                    if (tones[char]) {
                        toneChar = tones[char];
                    } else {
                        newWord += char;
                    }
                }
                let processedWord = newWord
                    .replace(/a\u0302/gi, 'aa').replace(/e\u0302/gi, 'ee').replace(/o\u0302/gi, 'oo')
                    .replace(/a\u0306/gi, 'aw').replace(/o\u031B/gi, 'ow').replace(/u\u031B/gi, 'uw');
                processedWord = processedWord.replace(/[\u0300-\u036f]/g, '').toUpperCase();
                return processedWord + toneChar;
            }).join(' ');
        };

        // --- UTILS: AUDIO ---
        class MorseAudioEngine {
            constructor() {
                this.audioContext = null;
                this.gainNode = null;
                this.isPlaying = false;
                this.timeouts = [];
            }
            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.connect(this.audioContext.destination);
                    this.gainNode.gain.value = 0;
                }
            }
            playTone(duration, frequency = 750) {
                this.init();
                if (!this.audioContext || !this.gainNode) return;
                const osc = this.audioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                osc.connect(this.gainNode);
                const now = this.audioContext.currentTime;
                const attack = 0.005; 
                const release = 0.005;
                osc.start(now);
                this.gainNode.gain.cancelScheduledValues(now);
                this.gainNode.gain.setValueAtTime(0, now);
                this.gainNode.gain.linearRampToValueAtTime(1, now + attack);
                this.gainNode.gain.setValueAtTime(1, now + duration - release);
                this.gainNode.gain.linearRampToValueAtTime(0, now + duration);
                osc.stop(now + duration + 0.05);
            }
            stop() {
                this.isPlaying = false;
                this.timeouts.forEach(t => clearTimeout(t));
                this.timeouts = [];
                if (this.gainNode && this.audioContext) {
                    this.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime);
                    this.gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                }
            }
            async playMessage(message, wpm, onCharFinish, onFinish) {
                this.stop();
                this.isPlaying = true;
                const unitTime = 1200 / wpm; 
                let currentTimeOffset = 0;
                const schedule = (fn, delay) => {
                    const t = setTimeout(fn, delay);
                    this.timeouts.push(t);
                };
                const cleanMessage = message.toUpperCase();
                for (let i = 0; i < cleanMessage.length; i++) {
                    if (!this.isPlaying) break;
                    const char = cleanMessage[i];
                    const code = MORSE_CODE[char];
                    if (char === ' ') {
                        currentTimeOffset += unitTime * 7;
                        continue;
                    }
                    if (code) {
                        schedule(() => { onCharFinish(char); }, currentTimeOffset);
                        for (let j = 0; j < code.length; j++) {
                            const symbol = code[j];
                            const duration = symbol === '.' ? unitTime : unitTime * 3;
                            schedule(() => { this.playTone(duration / 1000, 750); }, currentTimeOffset);
                            currentTimeOffset += duration; 
                            currentTimeOffset += unitTime; 
                        }
                        currentTimeOffset += unitTime * 2; 
                    }
                }
                schedule(() => { onFinish(); this.isPlaying = false; }, currentTimeOffset);
            }
        }
        const morseEngine = new MorseAudioEngine();

        // --- SERVICES: GEMINI ---
        const getSystemInstruction = (mode) => `
            B·∫°n l√† m·ªôt Hu·∫•n luy·ªán vi√™n Kim ƒê·ªìng c·∫•p 2 (Scout Trainer).
            Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o ra c√°c b·∫£n tin ng·∫Øn b·∫±ng TI·∫æNG VI·ªÜT CHU·∫®N (c√≥ d·∫•u) ƒë·ªÉ luy·ªán t·∫≠p ${mode}.
            Y√™u c·∫ßu:
            1. N·ªôi dung: C√°c c√¢u kh·∫©u hi·ªáu, ch√¢m ng√¥n, k·ªπ nƒÉng ƒê·ªôi vi√™n, thi√™n nhi√™n, c·∫Øm tr·∫°i, l√≤ng y√™u n∆∞·ªõc.
            2. Tuy·ªát ƒë·ªëi KH√îNG tr·∫£ v·ªÅ l·ªùi d·∫´n, ch·ªâ tr·∫£ v·ªÅ n·ªôi dung b·∫£n tin.
            3. Kh√¥ng s·ª≠ d·ª•ng k√Ω t·ª± ƒë·∫∑c bi·ªát ngo√†i ch·ªØ c√°i v√† s·ªë.
        `;
        
        const generatePracticeText = async (mode, wordCount, apiKey) => {
            try {
                if (!apiKey) {
                    throw new Error("API Key Missing");
                }
                const ai = new GoogleGenAI({ apiKey: apiKey });
                const response = await ai.models.generateContent({
                    model: 'gemini-1.5-flash',
                    contents: `T·∫°o m·ªôt c√¢u ho·∫∑c c·ª•m t·ª´ ti·∫øng Vi·ªát c√≥ √Ω nghƒ©a, ƒë·ªô d√†i kho·∫£ng ${wordCount} t·ª´.`,
                    config: {
                        systemInstruction: getSystemInstruction(mode),
                        temperature: 1, 
                    }
                });
                let text = response.text || "LOI KET NOI";
                text = text.replace(/\s+/g, ' ').replace(/["']/g, '').trim();
                return text;
            } catch (error) {
                console.error("Gemini gen error:", error);
                // Retrow to handle in UI
                throw error;
            }
        };

        // --- COMPONENTS ---
        
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
            const [localKey, setLocalKey] = useState(apiKey);

            useEffect(() => {
                setLocalKey(apiKey);
            }, [apiKey]);

            const handleSave = () => {
                setApiKey(localKey);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-[fadeIn_0.2s_ease-out]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
                            <X size={24} />
                        </button>
                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <Settings className="text-slate-600" /> C√†i ƒë·∫∑t ·ª®ng d·ª•ng
                        </h2>
                        
                        <div className="mb-6">
                            <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                <Key size={16} /> Google Gemini API Key
                            </label>
                            <input 
                                type="password" 
                                value={localKey}
                                onChange={(e) => setLocalKey(e.target.value)}
                                placeholder="Nh·∫≠p API Key b·∫Øt ƒë·∫ßu b·∫±ng AIza..."
                                className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-sky-500 focus:outline-none font-mono text-sm"
                            />
                            <p className="text-xs text-slate-500 mt-2 leading-relaxed">
                                C·∫ßn thi·∫øt ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng "ƒê·ªÅ AI". Kh√≥a ƒë∆∞·ª£c l∆∞u an to√†n trong tr√¨nh duy·ªát c·ªßa b·∫°n.
                                <br/>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-sky-600 hover:underline">L·∫•y API Key t·∫°i ƒë√¢y</a>
                            </p>
                        </div>

                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-lg transition-colors">
                                ƒê√≥ng
                            </button>
                            <button onClick={handleSave} className="px-4 py-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-2">
                                <Save size={18} /> L∆∞u C√†i ƒê·∫∑t
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SemaphoreFigure = ({ char, size = 300 }) => {
            const angles = SEMAPHORE_CSS_ANGLES[char] || SEMAPHORE_CSS_ANGLES['REST'];
            const mapRightArmToSVG = (cssAngle) => 90 + cssAngle;
            const mapLeftArmToSVG = (cssAngle) => 90 + cssAngle;
            const rightArmRot = mapRightArmToSVG(angles.rightArm);
            const leftArmRot = mapLeftArmToSVG(angles.leftArm);

            return (
                <div className="flex flex-col items-center justify-center p-4 bg-white rounded-xl shadow-inner border border-slate-200" style={{ width: size, height: size }}>
                    <svg width="100%" height="100%" viewBox="0 0 400 400">
                        <ellipse cx="200" cy="350" rx="100" ry="15" fill="#e2e8f0" />
                        <rect x="180" y="150" width="40" height="160" rx="10" fill="#334155" />
                        <circle cx="200" cy="110" r="30" fill="#f8d7da" stroke="#334155" strokeWidth="3" />
                        <path d="M 170 100 Q 200 70 230 100 L 240 100 L 160 100 Z" fill="#fff" stroke="#334155" strokeWidth="2" />
                        <g transform={`rotate(${rightArmRot}, 180, 160)`}>
                            <rect x="180" y="160" width="100" height="15" rx="7" fill="#334155" />
                            <line x1="270" y1="167" x2="330" y2="167" stroke="#8B4513" strokeWidth="4" />
                            <g transform="translate(280, 137)">
                                <path d="M 0 0 L 60 0 L 0 60 Z" fill="#FACC15" />
                                <path d="M 60 0 L 60 60 L 0 60 Z" fill="#EF4444" />
                                <rect x="0" y="0" width="60" height="60" fill="none" stroke="black" strokeWidth="0.5" />
                            </g>
                        </g>
                        <g transform={`rotate(${leftArmRot}, 220, 160)`}>
                            <rect x="220" y="160" width="100" height="15" rx="7" fill="#334155" />
                            <line x1="310" y1="167" x2="370" y2="167" stroke="#8B4513" strokeWidth="4" />
                            <g transform="translate(320, 137)">
                                <path d="M 0 0 L 60 0 L 0 60 Z" fill="#FACC15" />
                                <path d="M 60 0 L 60 60 L 0 60 Z" fill="#EF4444" />
                                <rect x="0" y="0" width="60" height="60" fill="none" stroke="black" strokeWidth="0.5" />
                            </g>
                        </g>
                    </svg>
                    <div className="mt-2 text-2xl font-bold font-mono text-slate-700 h-8">
                        {char === 'REST' || char === ' ' ? '...' : char}
                    </div>
                </div>
            );
        };

        const ReferencePanel = () => {
            const [activeTab, setActiveTab] = useState('MORSE');
            const MORSE_IMG_ID = "1Rcou2G1_pK_cKLCwhPcG3mJYIR25OWiD";
            const SEMAPHORE_IMG_ID = "1jtNFRsQqA36HTBMQ3LPZ6BxF4gOpZXhd";
            const getDrivePreviewUrl = (id) => `https://drive.google.com/file/d/${id}/preview`;

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 max-w-5xl mx-auto">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span>üìö</span> Tra C·ª©u T√†i Li·ªáu
                    </h2>
                    <div className="flex border-b border-slate-200 mb-6">
                        <button
                            onClick={() => setActiveTab('MORSE')}
                            className={`px-6 py-3 font-bold text-sm transition-colors relative ${activeTab === 'MORSE' ? 'text-sky-600 border-b-2 border-sky-600' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            B·∫¢NG M√É MORSE
                        </button>
                        <button
                            onClick={() => setActiveTab('SEMAPHORE')}
                            className={`px-6 py-3 font-bold text-sm transition-colors relative ${activeTab === 'SEMAPHORE' ? 'text-red-600 border-b-2 border-red-600' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            B·∫¢NG M√É SEMAPHORE
                        </button>
                    </div>
                    <div className="w-full aspect-[4/3] md:aspect-[16/9] bg-slate-50 rounded-xl overflow-hidden border border-slate-200 relative">
                        <iframe
                            src={getDrivePreviewUrl(activeTab === 'MORSE' ? MORSE_IMG_ID : SEMAPHORE_IMG_ID)}
                            className="absolute inset-0 w-full h-full border-none"
                            title="T√†i li·ªáu tham kh·∫£o"
                            allow="autoplay"
                        ></iframe>
                    </div>
                    <p className="mt-4 text-xs text-slate-400 italic text-center">Ngu·ªìn: T√†i li·ªáu Hu·∫•n luy·ªán Kim ƒê·ªìng</p>
                </div>
            );
        };

        const MorseTrainer = ({ apiKey, openSettings }) => {
            const [text, setText] = useState('CH√ÄO M·ªåI NG∆Ø·ªúI');
            const [isPlaying, setIsPlaying] = useState(false);
            const [wpm, setWpm] = useState(12);
            const [wordCount, setWordCount] = useState(5);
            const [currentChar, setCurrentChar] = useState('');
            const [userAnswer, setUserAnswer] = useState('');
            const [isCorrect, setIsCorrect] = useState(null);
            const [loadingAI, setLoadingAI] = useState(false);
            const telexText = toTelex(text);

            useEffect(() => {
                return () => morseEngine.stop();
            }, []);

            const handlePlay = () => {
                if (isPlaying) {
                    morseEngine.stop();
                    setIsPlaying(false);
                    setCurrentChar('');
                } else {
                    setIsPlaying(true);
                    setUserAnswer('');
                    setIsCorrect(null);
                    morseEngine.playMessage(
                        telexText, 
                        wpm, 
                        (char) => setCurrentChar(char), 
                        () => {
                            setIsPlaying(false);
                            setCurrentChar('');
                        }
                    );
                }
            };

            const checkAnswer = () => {
                const normalize = (s) => s.trim().toUpperCase();
                const user = normalize(userAnswer);
                if (user === normalize(text) || user === normalize(telexText)) {
                    setIsCorrect(true);
                } else {
                    setIsCorrect(false);
                }
            };

            const handleGenerate = async () => {
                if (!apiKey) {
                    openSettings();
                    return;
                }
                setLoadingAI(true);
                try {
                    const newText = await generatePracticeText('Morse', wordCount, apiKey);
                    setText(newText);
                    setUserAnswer('');
                    setIsCorrect(null);
                } catch(e) {
                    alert("L·ªói khi t·∫°o ƒë·ªÅ: " + e.message + "\nVui l√≤ng ki·ªÉm tra l·∫°i API Key.");
                } finally {
                    setLoadingAI(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 max-w-2xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <span className="text-sky-600">‚óè‚ñ¨‚óè</span> Luy·ªán Nghe Morse
                        </h2>
                        <div className="px-3 py-1 bg-sky-100 text-sky-800 rounded-full text-xs font-bold">C√≤i Th√©p ‚Ä¢ Chu·∫©n Telex</div>
                    </div>
                    <div className="mb-6 bg-slate-50 p-4 rounded-xl space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-2">T·ªëc ƒë·ªô: <span className="text-sky-600 font-bold">{wpm} WPM</span></label>
                            <input type="range" min="5" max="30" value={wpm} onChange={(e) => setWpm(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-600" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-2">ƒê·ªô d√†i b·∫£n tin: <span className="text-sky-600 font-bold">{wordCount} t·ª´</span></label>
                            <input type="range" min="1" max="20" value={wordCount} onChange={(e) => setWordCount(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-600" />
                        </div>
                    </div>
                    <div className="h-24 bg-slate-900 rounded-xl flex items-center justify-center mb-6 relative overflow-hidden">
                        {isPlaying ? <div className="text-6xl font-mono font-bold text-green-500 animate-pulse transition-all">{currentChar ? 'üîä' : '...'}</div> : <div className="text-slate-500 text-sm">S·∫µn s√†ng ph√°t tin</div>}
                        {isPlaying && currentChar && <div className="absolute bottom-0 left-0 w-full h-1 bg-green-500/50"></div>}
                    </div>
                    <div className="flex gap-3 mb-8">
                        <button onClick={handlePlay} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-white transition-all shadow-md ${isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700'}`}>
                            {isPlaying ? <><Square size={20} fill="currentColor" /> D·ª´ng</> : <><Play size={20} fill="currentColor" /> Ph√°t Tin</>}
                        </button>
                        <button onClick={handleGenerate} disabled={loadingAI || isPlaying} className="px-4 py-3 bg-indigo-100 text-indigo-700 rounded-xl hover:bg-indigo-200 transition-colors flex items-center gap-2 font-medium">
                            {loadingAI ? <RefreshCw className="animate-spin" size={20} /> : <><Wand2 size={20} /> ƒê·ªÅ AI</>}
                        </button>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1">N·ªôi dung gi·∫£i m√£ (Ti·∫øng Vi·ªát ho·∫∑c Telex):</label>
                            <input type="text" value={userAnswer} onChange={(e) => setUserAnswer(e.target.value.toUpperCase())} placeholder="V√≠ d·ª•: CH√ÄO ho·∫∑c CHAOF..." className="w-full p-4 border-2 border-slate-200 rounded-xl focus:border-sky-500 focus:outline-none font-mono text-lg uppercase" />
                        </div>
                        <button onClick={checkAnswer} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-colors">Ki·ªÉm Tra K·∫øt Qu·∫£</button>
                        {isCorrect !== null && (
                            <div className={`p-4 rounded-xl text-center font-bold flex flex-col gap-1 ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                <span>{isCorrect ? 'CH√çNH X√ÅC! TUY·ªÜT V·ªúI!' : 'SAI R·ªíI!'}</span>
                                {!isCorrect && <span className="text-sm font-normal">ƒê√°p √°n: <strong>{text}</strong> <span className="opacity-75">({telexText})</span></span>}
                            </div>
                        )}
                    </div>
                    <div className="mt-6 pt-4 border-t border-slate-100">
                        <details className="text-sm text-slate-500">
                            <summary className="cursor-pointer hover:text-sky-600">Xem m√£ ph√°t (D√†nh cho ng∆∞·ªùi ki·ªÉm tra)</summary>
                            <div className="mt-2 p-3 bg-slate-50 rounded-lg font-mono text-sm text-slate-900">
                                <div className="mb-2"><span className="text-slate-500">G·ªëc:</span> {text}</div>
                                <div className="mb-2"><span className="text-slate-500">Telex:</span> {telexText}</div>
                                <div className="text-xs text-slate-400 tracking-wider">
                                {telexText.split('').map((c, i) => (
                                    MORSE_CODE[c] ? <span key={i} className="mr-1">{MORSE_CODE[c]}</span> : <span key={i} className="mr-1 mx-2">/</span>
                                ))}
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            );
        };

        const SemaphoreTrainer = ({ apiKey, openSettings }) => {
            const [text, setText] = useState('T·ª∞ H√ÄO');
            const [isPlaying, setIsPlaying] = useState(false);
            const [speed, setSpeed] = useState(2000); 
            const [wordCount, setWordCount] = useState(2);
            const [currentIndex, setCurrentIndex] = useState(-1);
            const [userAnswer, setUserAnswer] = useState('');
            const [isCorrect, setIsCorrect] = useState(null);
            const [loadingAI, setLoadingAI] = useState(false);
            const timerRef = useRef(null);
            const telexText = toTelex(text);

            useEffect(() => {
                if (isPlaying) {
                    timerRef.current = setInterval(() => {
                        setCurrentIndex((prev) => {
                            if (prev >= telexText.length - 1) {
                                setIsPlaying(false);
                                return -1; 
                            }
                            return prev + 1;
                        });
                    }, speed);
                } else {
                    if (timerRef.current) clearInterval(timerRef.current);
                }
                return () => {
                    if (timerRef.current) clearInterval(timerRef.current);
                };
            }, [isPlaying, telexText, speed]);

            const handlePlay = () => {
                if (isPlaying) {
                    setIsPlaying(false);
                    setCurrentIndex(-1);
                } else {
                    setIsPlaying(true);
                    setCurrentIndex(0); 
                    setUserAnswer('');
                    setIsCorrect(null);
                }
            };

            const handleGenerate = async () => {
                if (!apiKey) {
                    openSettings();
                    return;
                }
                setLoadingAI(true);
                try {
                    const newText = await generatePracticeText('Semaphore', wordCount, apiKey);
                    setText(newText);
                    setUserAnswer('');
                    setIsCorrect(null);
                    setCurrentIndex(-1);
                } catch(e) {
                    alert("L·ªói khi t·∫°o ƒë·ªÅ: " + e.message + "\nVui l√≤ng ki·ªÉm tra l·∫°i API Key.");
                } finally {
                    setLoadingAI(false);
                }
            };

            const checkAnswer = () => {
                const normalize = (s) => s.trim().toUpperCase();
                const user = normalize(userAnswer);
                if (user === normalize(text) || user === normalize(telexText)) {
                    setIsCorrect(true);
                } else {
                    setIsCorrect(false);
                }
            };

            const currentChar = currentIndex >= 0 && currentIndex < telexText.length ? telexText[currentIndex] : 'REST';

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 max-w-2xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <span className="text-red-500">üö©</span> Luy·ªán Semaphore
                        </h2>
                        <div className="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">Ti√™u Chu·∫©n Telex</div>
                    </div>
                    <div className="mb-6 bg-slate-50 p-4 rounded-xl space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-2">T·ªëc ƒë·ªô ƒë√°nh: <span className="text-red-600 font-bold">{(speed/1000).toFixed(1)}s / k√Ω t·ª±</span></label>
                            <input type="range" min="500" max="4000" step="100" value={speed} onChange={(e) => setSpeed(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-2">ƒê·ªô d√†i b·∫£n tin: <span className="text-red-600 font-bold">{wordCount} t·ª´</span></label>
                            <input type="range" min="1" max="20" value={wordCount} onChange={(e) => setWordCount(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500" />
                        </div>
                    </div>
                    <div className="flex justify-center mb-8 relative">
                        <SemaphoreFigure char={currentChar} />
                        {isPlaying && <div className="absolute top-2 right-2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-50">{currentIndex + 1} / {telexText.length}</div>}
                    </div>
                    {isPlaying && (
                        <div className="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden">
                            <div className="bg-red-500 h-full transition-all duration-300 ease-linear" style={{ width: `${((currentIndex + 1) / telexText.length) * 100}%` }}></div>
                        </div>
                    )}
                    <div className="flex gap-3 mb-8">
                        <button onClick={handlePlay} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-white transition-all shadow-md ${isPlaying ? 'bg-slate-500 hover:bg-slate-600' : 'bg-red-600 hover:bg-red-700'}`}>
                            {isPlaying ? <><Square size={20} fill="currentColor" /> D·ª´ng</> : <><Play size={20} fill="currentColor" /> B·∫Øt ƒë·∫ßu ƒë√°nh</>}
                        </button>
                        <button onClick={handleGenerate} disabled={loadingAI || isPlaying} className="px-4 py-3 bg-orange-100 text-orange-700 rounded-xl hover:bg-orange-200 transition-colors flex items-center gap-2 font-medium">
                            {loadingAI ? <RefreshCw className="animate-spin" size={20} /> : <><Wand2 size={20} /> ƒê·ªÅ AI</>}
                        </button>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1">N·ªôi dung gi·∫£i m√£ (Ti·∫øng Vi·ªát/Telex):</label>
                            <input type="text" value={userAnswer} onChange={(e) => setUserAnswer(e.target.value.toUpperCase())} placeholder="V√≠ d·ª•: T·ª∞ H√ÄO..." className="w-full p-4 border-2 border-slate-200 rounded-xl focus:border-red-500 focus:outline-none font-mono text-lg uppercase" />
                        </div>
                        <button onClick={checkAnswer} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-colors">Ki·ªÉm Tra K·∫øt Qu·∫£</button>
                        {isCorrect !== null && (
                            <div className={`p-4 rounded-xl text-center font-bold flex flex-col gap-1 ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                <span>{isCorrect ? 'CH√çNH X√ÅC!' : 'SAI R·ªíI!'}</span>
                                {!isCorrect && <span className="text-sm font-normal">ƒê√°p √°n: <strong>{text}</strong> <span className="opacity-75">({telexText})</span></span>}
                            </div>
                        )}
                    </div>
                    <div className="mt-6 pt-4 border-t border-slate-100">
                        <details className="text-sm text-slate-500">
                            <summary className="cursor-pointer hover:text-red-600">Xem m√£ ph√°t</summary>
                            <div className="mt-2 p-3 bg-slate-50 rounded-lg font-mono text-sm text-slate-900 text-center">
                                <div className="mb-2 font-bold">{text}</div>
                                <div className="text-slate-500 tracking-widest">{telexText}</div>
                            </div>
                        </details>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('MORSE');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('GEMINI_API_KEY') || '');

            const updateApiKey = (newKey) => {
                setApiKey(newKey);
                localStorage.setItem('GEMINI_API_KEY', newKey);
            };

            const openSettings = () => setIsSettingsOpen(true);

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans">
                    <header className="bg-slate-900 text-white pt-8 pb-16 px-4 shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
                            <Flag size={200} />
                        </div>
                        {/* Settings Button */}
                        <div className="absolute top-4 right-4 z-20">
                            <button 
                                onClick={() => setIsSettingsOpen(true)}
                                className="p-2 rounded-full bg-slate-800/50 hover:bg-slate-700 text-slate-300 hover:text-white transition-all backdrop-blur-sm border border-slate-700"
                                title="C√†i ƒë·∫∑t API Key"
                            >
                                <Settings size={20} />
                            </button>
                        </div>

                        <div className="max-w-4xl mx-auto relative z-10 text-center">
                            <div className="inline-flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full text-xs font-bold text-sky-400 mb-4 border border-slate-700">
                                <GraduationCap size={14} /> HU·∫§N LUY·ªÜN VI√äN C·∫§P 2
                            </div>
                            <h1 className="text-3xl md:text-4xl font-black tracking-tight mb-2">R√®n Luy·ªán K·ªπ NƒÉng ƒê·ªôi Vi√™n</h1>
                        </div>
                    </header>
                    <main className="flex-1 px-4 -mt-8 pb-12">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white p-2 rounded-2xl shadow-lg mb-8 flex gap-2 overflow-x-auto max-w-2xl mx-auto">
                                <button onClick={() => setCurrentView('MORSE')} className={`flex-1 py-3 px-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all whitespace-nowrap min-w-[120px] ${currentView === 'MORSE' ? 'bg-sky-600 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-50'}`}><Radio size={18} /> Morse</button>
                                <button onClick={() => setCurrentView('SEMAPHORE')} className={`flex-1 py-3 px-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all whitespace-nowrap min-w-[120px] ${currentView === 'SEMAPHORE' ? 'bg-red-600 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-50'}`}><Flag size={18} /> Semaphore</button>
                                <button onClick={() => setCurrentView('REFERENCE')} className={`flex-1 py-3 px-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all whitespace-nowrap min-w-[120px] ${currentView === 'REFERENCE' ? 'bg-amber-500 text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-50'}`}><BookOpen size={18} /> Tra C·ª©u</button>
                            </div>
                            <div className="transition-all duration-500 ease-in-out">
                                {currentView === 'MORSE' && <MorseTrainer apiKey={apiKey} openSettings={openSettings} />}
                                {currentView === 'SEMAPHORE' && <SemaphoreTrainer apiKey={apiKey} openSettings={openSettings} />}
                                {currentView === 'REFERENCE' && <ReferencePanel />}
                            </div>
                        </div>
                    </main>
                    <footer className="bg-white border-t border-slate-200 py-6 text-center text-slate-400 text-sm">
                        <p>¬© 2024 Kim Dong Scout Trainer Tools. Ready for Service.</p>
                        <p className="mt-1 text-xs">S·ª≠ d·ª•ng Gemini AI ƒë·ªÉ t·∫°o b√†i t·∫≠p phong ph√∫.</p>
                    </footer>

                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        apiKey={apiKey} 
                        setApiKey={updateApiKey} 
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>