<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫°m Hu·∫•n Luy·ªán Morse & Semaphore - HLV C·∫•p 2 Trung ∆Ø∆°ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .code-font {
            font-family: 'JetBrains+Mono', monospace;
        }

        .active-glow {
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.7);
            transition: all 0.1s ease;
        }

        #armLeft line, #armRight line, #armLeft rect, #armRight rect {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .correct-pulse {
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .status-blink {
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="p-2 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="bg-emerald-800 text-white p-6 rounded-3xl shadow-2xl mb-6 flex flex-col md:flex-row items-center gap-6">
            <div class="bg-white text-emerald-800 p-4 rounded-full w-20 h-20 flex items-center justify-center font-bold text-3xl shadow-inner border-4 border-emerald-600">
                HLV
            </div>
            <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight uppercase">Tr·∫°m Hu·∫•n Luy·ªán Morse & Semaphore</h1>
                <p class="text-emerald-100 opacity-90 italic text-sm md:text-base italic">K·ªπ nƒÉng chuy√™n m√¥n ƒê·ªôi - Hu·∫•n luy·ªán vi√™n C·∫•p 2 Trung ∆∞∆°ng</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Training/Test Section -->
                <section class="bg-white p-6 rounded-3xl shadow-md border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <label id="inputLabel" class="text-slate-700 font-bold flex items-center gap-2">
                            <span class="text-emerald-600">üìù</span> So·∫°n th·∫£o b·∫£n tin:
                        </label>
                        <div class="flex gap-2">
                            <button id="btnAiQuiz" class="text-sm bg-orange-100 text-orange-700 hover:bg-orange-200 px-4 py-2 rounded-full font-bold transition-all flex items-center gap-2">
                                <span id="aiIcon">üéØ Th·ª≠ th√°ch Ki·ªÉm tra</span>
                            </button>
                            <button id="btnNormalMode" class="text-sm bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-full font-bold transition-all hidden">
                                üîô Quay l·∫°i T·ª± luy·ªán
                            </button>
                        </div>
                    </div>

                    <!-- Normal Input -->
                    <div id="normalInputGroup">
                        <textarea id="textInput" 
                            class="w-full h-24 p-4 bg-slate-50 border border-slate-300 rounded-2xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all text-xl font-medium"
                            placeholder="Nh·∫≠p n·ªôi dung c·∫ßn truy·ªÅn ƒë·∫°t..."></textarea>
                    </div>

                    <!-- Test Input Group -->
                    <div id="testInputGroup" class="hidden space-y-4">
                        <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 mb-4">
                            <p class="text-orange-800 text-sm font-bold">‚ö†Ô∏è B·∫¢N TIN ƒê√É B·ªä ·∫®N. H√£y nghe Morse ho·∫∑c nh√¨n Semaphore ƒë·ªÉ gi·∫£i m√£!</p>
                        </div>
                        <input type="text" id="userGuess" 
                            class="w-full p-5 bg-white border-2 border-orange-300 rounded-2xl focus:ring-4 focus:ring-orange-500/20 focus:border-orange-500 outline-none transition-all text-xl font-bold text-orange-700"
                            placeholder="Nh·∫≠p ƒë√°p √°n b·∫°n nghe ƒë∆∞·ª£c v√†o ƒë√¢y...">
                        <div class="flex gap-2">
                            <button id="btnCheckAnswer" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-bold flex-1 transition-all shadow-lg active:scale-95">
                                Ki·ªÉm tra ƒë√°p √°n
                            </button>
                            <button id="btnToggleReveal" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-3 rounded-xl font-bold transition-all">
                                Xem k·∫øt qu·∫£
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex flex-wrap gap-3">
                        <button id="btnPlayMorse" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 transition-all shadow-lg active:scale-95 flex-1 min-w-[150px]">
                            <span class="text-xl">üîä</span> Th·ªïi Morse
                        </button>
                        <button id="btnPlaySema" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-2xl font-bold flex items-center gap-3 transition-all shadow-lg active:scale-95 flex-1 min-w-[150px]">
                            <span class="text-xl">üö©</span> Semaphore
                        </button>
                        <button id="btnStop" class="bg-slate-800 hover:bg-black text-white px-8 py-4 rounded-2xl font-bold transition-all shadow-lg active:scale-95">
                            D·ª´ng
                        </button>
                    </div>
                </section>

                <!-- Analysis Section -->
                <section id="resultSection" class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 overflow-hidden transition-all">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        üì° Ph√¢n t√≠ch b·∫£n tin (Chu·∫©n Telex)
                    </h3>
                    <div id="answerContent">
                        <div id="telexPreview" class="bg-slate-900 text-emerald-400 p-5 rounded-2xl code-font min-h-[60px] text-xl break-all mb-3 leading-relaxed">
                            Ch∆∞a c√≥ b·∫£n tin...
                        </div>
                        <div id="morsePreview" class="bg-slate-100 text-slate-600 p-5 rounded-2xl code-font text-2xl tracking-widest break-all">
                            ...
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Semaphore -->
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 text-center relative overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-6">Tr·∫°m Semaphore</h3>
                    <div id="semaContainer" class="flex justify-center bg-slate-50 p-6 rounded-3xl h-64 items-center border border-slate-100">
                        <svg id="semaSvg" viewBox="0 0 100 100" class="w-full h-full max-w-[200px]">
                            <circle cx="50" cy="25" r="8" fill="#334155" />
                            <line x1="50" y1="33" x2="50" y2="70" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            <line x1="50" y1="70" x2="35" y2="95" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            <line x1="50" y1="70" x2="65" y2="95" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                            <g id="armLeft">
                                <line x1="50" y1="40" x2="20" y2="40" stroke="#dc2626" stroke-width="5" stroke-linecap="round" />
                                <rect x="15" y="30" width="12" height="12" fill="#ef4444" rx="1" />
                                <rect x="15" y="30" width="6" height="6" fill="#fbbf24" rx="1" />
                            </g>
                            <g id="armRight">
                                <line x1="50" y1="40" x2="80" y2="40" stroke="#dc2626" stroke-width="5" stroke-linecap="round" />
                                <rect x="73" y="30" width="12" height="12" fill="#ef4444" rx="1" />
                                <rect x="73" y="30" width="6" height="6" fill="#fbbf24" rx="1" />
                            </g>
                        </svg>
                    </div>
                    <div class="mt-4 flex flex-col items-center">
                        <div id="semaStatus" class="text-xs font-bold text-slate-400 mb-1 h-4 uppercase tracking-widest"></div>
                        <div id="semaChar" class="text-4xl font-black text-blue-600 h-10 italic"></div>
                    </div>
                </div>

                <!-- Morse Light -->
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-200 text-center">
                    <h3 class="font-bold text-slate-700 mb-4">ƒê√®n T√≠n Hi·ªáu</h3>
                    <div id="morseLight" class="w-20 h-20 bg-slate-200 rounded-full mx-auto border-4 border-slate-300 transition-colors"></div>
                </div>

                <!-- Settings -->
                <div class="bg-emerald-900 text-white p-6 rounded-3xl shadow-xl">
                    <h3 class="font-bold mb-6 flex items-center gap-2">‚öôÔ∏è C·∫•u h√¨nh HLV</h3>
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold uppercase text-emerald-300 mb-2 tracking-widest">
                                <span>T·ªëc ƒë·ªô Morse</span>
                                <span><span id="wpmVal">15</span> WPM</span>
                            </div>
                            <input type="range" id="wpmSlider" min="5" max="35" value="15" class="w-full accent-emerald-400 h-1.5 bg-emerald-800 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold uppercase text-blue-300 mb-2 tracking-widest">
                                <span>T·ªëc ƒë·ªô Semaphore</span>
                                <span><span id="semaVal">1000</span> ms</span>
                            </div>
                            <input type="range" id="semaSlider" min="300" max="3000" step="100" value="1000" class="w-full accent-blue-400 h-1.5 bg-emerald-800 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification system -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl hidden opacity-0 transition-all font-bold shadow-2xl z-50 border border-slate-700"></div>

    <script>
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'morse-sema-trainer';

        // --- DATA ---
        const MORSE_MAP = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....',
            'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---', 'P': '.--.',
            'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....',
            '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----', ' ': '/'
        };

        const TELEX_MAP = {
            '√°': 'as', '√†': 'af', '·∫£': 'ar', '√£': 'ax', '·∫°': 'aj', '√¢': 'aa', '·∫•': 'aas', '·∫ß': 'aaf', '·∫©': 'aar', '·∫´': 'aax', '·∫≠': 'aaj', 'ƒÉ': 'aw', '·∫Ø': 'aws', '·∫±': 'awf', '·∫≥': 'awr', '·∫µ': 'awx', '·∫∑': 'awj',
            '√©': 'es', '√®': 'ef', '·∫ª': 'er', '·∫Ω': 'ex', '·∫π': 'ej', '√™': 'ee', '·∫ø': 'ees', '·ªÅ': 'eef', '·ªÉ': 'eer', '·ªÖ': 'eex', '·ªá': 'eej',
            '√≠': 'is', '√¨': 'if', '·ªâ': 'ir', 'ƒ©': 'ix', '·ªã': 'ij', '√≥': 'os', '√≤': 'of', '·ªè': 'or', '√µ': 'ox', '·ªç': 'oj', '√¥': 'oo', '·ªë': 'oos', '·ªì': 'oof', '·ªï': 'oor', '·ªó': 'oox', '·ªô': 'ooj',
            '∆°': 'ow', '·ªõ': 'ows', '·ªù': 'owf', '·ªü': 'owr', '·ª°': 'owx', '·ª£': 'owj', '√∫': 'us', '√π': 'uf', '·ªß': 'ur', '≈©': 'ux', '·ª•': 'uj', '∆∞': 'uw', '·ª©': 'uws', '·ª´': 'uwf', '·ª≠': 'uwr', '·ªØ': 'uwx', '·ª±': 'uwj',
            '√Ω': 'ys', '·ª≥': 'yf', '·ª∑': 'yr', '·ªπ': 'yx', '·ªµ': 'yj', 'ƒë': 'dd'
        };

        const SEMA_ANGLES = {
            'A': [180, 225], 'B': [180, 270], 'C': [180, 315], 'D': [180, 0],
            'E': [180, 45],  'F': [180, 90],  'G': [180, 135], 'H': [225, 270],
            'I': [225, 315], 'K': [225, 0],   'L': [225, 45],  'M': [225, 90],
            'N': [225, 135], 'O': [270, 315], 'P': [270, 0],   'Q': [270, 45],
            'R': [270, 90],  'S': [270, 135], 'T': [315, 0],   'U': [315, 45],
            'Y': [90, 315],  'V': [0, 45],    'W': [45, 90],   'X': [45, 135],
            'Z': [90, 135],  'J': [0, 90],    ' ': [180, 180],
            'READY': [180, 180]
        };

        // --- STATE ---
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let isPlaying = false;
        let isTestMode = false;
        let currentTargetMessage = "";
        let timeouts = [];

        // --- UTILS ---
        function cleanText(t) {
            return t.trim().toLowerCase().replace(/[.,!?;:]/g, "");
        }

        function toTelex(text) {
            let res = "";
            for (let char of text.toLowerCase()) {
                res += TELEX_MAP[char] || char;
            }
            return res.toUpperCase();
        }

        function toMorse(telex) {
            return telex.split('').map(c => MORSE_MAP[c] || '').join(' ').replace(/\s+/g, ' ').trim();
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioCtx.createGain();
                gainNode.connect(audioCtx.destination);
            }
        }

        function stopAll() {
            isPlaying = false;
            timeouts.forEach(clearTimeout);
            timeouts = [];
            if (gainNode) gainNode.gain.setTargetAtTime(0, audioCtx?.currentTime || 0, 0.05);
            if (oscillator) { try { oscillator.stop(); } catch(e){} oscillator = null; }
            document.getElementById('morseLight').className = 'w-20 h-20 bg-slate-200 rounded-full mx-auto border-4 border-slate-300 transition-colors';
            document.getElementById('semaChar').innerText = "";
            document.getElementById('semaStatus').innerText = "";
            document.getElementById('semaStatus').classList.remove('status-blink', 'text-orange-500');
            setArms(180, 180);
        }

        function setArms(leftAngle, rightAngle) {
            const lRad = (leftAngle - 90) * Math.PI / 180;
            const rRad = (rightAngle - 90) * Math.PI / 180;
            const xL = 50 + 35 * Math.cos(lRad); const yL = 40 + 35 * Math.sin(lRad);
            const xR = 50 + 35 * Math.cos(rRad); const yR = 40 + 35 * Math.sin(rRad);
            const armL = document.getElementById('armLeft');
            const armR = document.getElementById('armRight');
            armL.querySelector('line').setAttribute('x2', xL); armL.querySelector('line').setAttribute('y2', yL);
            armR.querySelector('line').setAttribute('x2', xR); armR.querySelector('line').setAttribute('y2', yR);
            armL.querySelector('rect:first-of-type').setAttribute('x', xL - 6); armL.querySelector('rect:first-of-type').setAttribute('y', yL - 6);
            armR.querySelector('rect:first-of-type').setAttribute('x', xR - 6); armR.querySelector('rect:first-of-type').setAttribute('y', yR - 6);
        }

        async function playCircleEight(onComplete) {
            const speed = 120;
            const sequence = [0, 45, 90, 135, 180, 225, 270, 315];
            document.getElementById('semaStatus').innerText = "V√íNG S·ªê 8";
            for (let r = 0; r < 2; r++) {
                for (let a of sequence) {
                    if (!isPlaying) return;
                    setArms(a, a + 180);
                    await new Promise(res => timeouts.push(setTimeout(res, speed)));
                }
            }
            onComplete();
        }

        function playSemaphore() {
            stopAll(); isPlaying = true;
            const text = isTestMode ? currentTargetMessage : document.getElementById('textInput').value;
            if (!text) return showToast("Vui l√≤ng so·∫°n b·∫£n tin!");
            const telex = toTelex(text);
            const speed = parseInt(document.getElementById('semaSlider').value);
            
            playCircleEight(() => {
                let idx = 0;
                let lastChar = "";

                function next() {
                    if (!isPlaying) return;
                    if (idx >= telex.length) {
                        playCircleEight(() => { stopAll(); document.getElementById('semaChar').innerText = "H·∫æT"; });
                        return;
                    }

                    const char = telex[idx];
                    
                    // Hi·ªáu ·ª©ng "Nh·∫•p ch·ªØ" khi 2 ch·ªØ c√°i gi·ªëng nhau li·ªÅn nhau
                    if (char === lastChar && char !== ' ') {
                        document.getElementById('semaStatus').innerText = "NH·∫§P CH·ªÆ";
                        document.getElementById('semaStatus').classList.add('status-blink', 'text-orange-500');
                        setArms(180, 180); // ƒê∆∞a v·ªÅ v·ªã tr√≠ ngh·ªâ
                        
                        // Ngh·ªâ m·ªôt n·ª≠a th·ªùi gian speed r·ªìi m·ªõi ph√°t l·∫°i ch·ªØ ƒë√≥
                        timeouts.push(setTimeout(() => {
                            if (!isPlaying) return;
                            document.getElementById('semaStatus').innerText = "PH√ÅT TIN";
                            document.getElementById('semaStatus').classList.remove('status-blink', 'text-orange-500');
                            displayChar(char);
                            lastChar = char;
                            idx++;
                            timeouts.push(setTimeout(next, speed));
                        }, speed / 2));
                    } else {
                        document.getElementById('semaStatus').innerText = "PH√ÅT TIN";
                        document.getElementById('semaStatus').classList.remove('status-blink', 'text-orange-500');
                        displayChar(char);
                        lastChar = char;
                        idx++;
                        timeouts.push(setTimeout(next, speed));
                    }
                }

                function displayChar(c) {
                    const angles = SEMA_ANGLES[c] || SEMA_ANGLES['READY'];
                    document.getElementById('semaChar').innerText = (c === ' ' || isTestMode) ? "???" : c;
                    setArms(angles[0], angles[1]);
                }

                next();
            });
        }

        function playMorse() {
            initAudio(); stopAll(); isPlaying = true;
            const text = isTestMode ? currentTargetMessage : document.getElementById('textInput').value;
            if (!text) return showToast("Vui l√≤ng so·∫°n b·∫£n tin!");
            const telex = toTelex(text);
            const wpm = parseInt(document.getElementById('wpmSlider').value);
            const dotTime = 1200 / wpm;
            let currentTime = 0;

            telex.split('').forEach(char => {
                if (!isPlaying) return;
                if (char === ' ') { currentTime += dotTime * 7; } 
                else {
                    (MORSE_MAP[char] || '').split('').forEach(sym => {
                        const dur = (sym === '.') ? dotTime : dotTime * 3;
                        const start = currentTime; const end = currentTime + dur;
                        timeouts.push(setTimeout(() => {
                            if (!isPlaying) return;
                            document.getElementById('morseLight').classList.add('bg-emerald-400', 'active-glow');
                            if (oscillator) oscillator.stop();
                            oscillator = audioCtx.createOscillator();
                            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                            oscillator.connect(gainNode);
                            gainNode.gain.setTargetAtTime(1, audioCtx.currentTime, 0.005);
                            oscillator.start();
                        }, start));
                        timeouts.push(setTimeout(() => {
                            document.getElementById('morseLight').classList.remove('bg-emerald-400', 'active-glow');
                            gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.005);
                        }, end));
                        currentTime += dur + dotTime;
                    });
                    currentTime += dotTime * 3;
                }
            });
        }

        // --- AI & MODES ---
        async function startAiQuiz() {
            const btn = document.getElementById('btnAiQuiz');
            const icon = document.getElementById('aiIcon');
            btn.disabled = true;
            icon.innerHTML = '<span class="loader"></span> ƒêang t·∫°o...';

            const sysPrompt = "B·∫°n l√† HLV Morse/Semaphore. H√£y t·∫°o 1 c√¢u b·∫£n tin ng·∫Øn b·∫±ng ti·∫øng Vi·ªát c√≥ d·∫•u, ƒë·ªô d√†i 15-25 k√Ω t·ª±. N·ªôi dung v·ªÅ ch·ªß ƒë·ªÅ ƒê·ªôi thi·∫øu ni√™n ti·ªÅn phong ho·∫∑c phong tr√†o thanh ni√™n (v√≠ d·ª•: 'S·∫µn s√†ng v√¨ T·ªï qu·ªëc', 'ƒêi ta ƒëi l√™n'). Ch·ªâ tr·∫£ v·ªÅ duy nh·∫•t b·∫£n tin ƒë√≥.";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "T·∫°o c√¢u m·ªõi ngay." }] }],
                        systemInstruction: { parts: [{ text: sysPrompt }] }
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "S·∫¥N S√ÄNG V√å T·ªî QU·ªêC";
                
                currentTargetMessage = text;
                enterTestMode();
                showToast("ƒê√£ t·∫°o b·∫£n tin ki·ªÉm tra m·ªõi!");
            } catch (e) {
                showToast("L·ªói k·∫øt n·ªëi AI. Vui l√≤ng th·ª≠ l·∫°i.");
            } finally {
                btn.disabled = false; icon.innerText = "üéØ Th·ª≠ th√°ch Ki·ªÉm tra";
            }
        }

        function enterTestMode() {
            isTestMode = true;
            document.getElementById('normalInputGroup').classList.add('hidden');
            document.getElementById('testInputGroup').classList.remove('hidden');
            document.getElementById('btnNormalMode').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('invisible');
            document.getElementById('userGuess').value = "";
            document.getElementById('inputLabel').innerHTML = '<span class="text-orange-600">üéØ</span> ƒêang trong ch·∫ø ƒë·ªô KI·ªÇM TRA';
            
            const telex = toTelex(currentTargetMessage);
            document.getElementById('telexPreview').innerText = telex;
            document.getElementById('morsePreview').innerText = toMorse(telex);
        }

        function exitTestMode() {
            isTestMode = false;
            stopAll();
            document.getElementById('normalInputGroup').classList.remove('hidden');
            document.getElementById('testInputGroup').classList.add('hidden');
            document.getElementById('btnNormalMode').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('invisible');
            document.getElementById('inputLabel').innerHTML = '<span class="text-emerald-600">üìù</span> So·∫°n th·∫£o b·∫£n tin:';
        }

        function checkAnswer() {
            const guess = cleanText(document.getElementById('userGuess').value);
            const target = cleanText(currentTargetMessage);
            
            if (!guess) return showToast("B·∫°n ch∆∞a nh·∫≠p ƒë√°p √°n!");

            if (guess === target) {
                showToast("CH√çNH X√ÅC! Ch√∫c m·ª´ng ƒë·ªìng ch√≠! üéâ");
                document.getElementById('userGuess').classList.add('correct-pulse', 'border-emerald-500');
                revealAnswer();
            } else {
                showToast("Sai r·ªìi! H√£y th·ª≠ nghe/nh√¨n l·∫°i nh√©.");
                document.getElementById('userGuess').classList.add('border-red-500');
                setTimeout(() => document.getElementById('userGuess').classList.remove('border-red-500'), 1000);
            }
        }

        function revealAnswer() {
            document.getElementById('resultSection').classList.remove('invisible');
            showToast("ƒê√£ hi·ªÉn th·ªã ƒë√°p √°n b·∫£n tin.");
        }

        // --- EVENTS ---
        document.getElementById('textInput').oninput = (e) => {
            const telex = toTelex(e.target.value);
            document.getElementById('telexPreview').innerText = telex || "Ch∆∞a c√≥ b·∫£n tin...";
            document.getElementById('morsePreview').innerText = toMorse(telex) || "...";
        };

        document.getElementById('btnAiQuiz').onclick = startAiQuiz;
        document.getElementById('btnNormalMode').onclick = exitTestMode;
        document.getElementById('btnCheckAnswer').onclick = checkAnswer;
        document.getElementById('btnToggleReveal').onclick = revealAnswer;
        document.getElementById('btnPlayMorse').onclick = playMorse;
        document.getElementById('btnPlaySema').onclick = playSemaphore;
        document.getElementById('btnStop').onclick = stopAll;

        document.getElementById('wpmSlider').oninput = (e) => document.getElementById('wpmVal').innerText = e.target.value;
        document.getElementById('semaSlider').oninput = (e) => document.getElementById('semaVal').innerText = e.target.value;

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.replace('opacity-0', 'opacity-100'), 10);
            setTimeout(() => {
                t.classList.replace('opacity-100', 'opacity-0');
                setTimeout(() => t.classList.add('hidden'), 500);
            }, 3000);
        }

        setArms(180, 180);
    </script>
</body>
</html>